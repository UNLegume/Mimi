import type { AiClient } from './types.js';
import type { Article } from '../sources/types.js';

export async function generateArticle(
  article: Article,
  client: AiClient,
  tone: string
): Promise<string> {
  const today = new Date().toISOString().split('T')[0];

  const primarySourceInfo = article.primarySourceUrl
    ? `ä¸€æ¬¡ã‚½ãƒ¼ã‚¹: ${article.primarySourceUrl}ï¼ˆç¨®åˆ¥: ${article.primarySourceType ?? 'unknown'}ï¼‰`
    : 'ä¸€æ¬¡ã‚½ãƒ¼ã‚¹: ãªã—';

  const contentSection = article.content
    ? `æœ¬æ–‡:\n${article.content.slice(0, 2000)}`
    : article.summary
    ? `ã‚µãƒãƒªãƒ¼:\n${article.summary}`
    : 'æœ¬æ–‡ãƒ»ã‚µãƒãƒªãƒ¼ãªã—';

  const toneInstruction = tone === 'technical'
    ? 'ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«ãªè§£èª¬èª¿ã§ã€å°‚é–€ç”¨èªã‚’æ­£ç¢ºã«ä½¿ã„ãªãŒã‚‰è©³ã—ãèª¬æ˜ã—ã¦ãã ã•ã„ã€‚'
    : tone === 'casual'
    ? 'ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ã§èª­ã¿ã‚„ã™ã„ãƒˆãƒ¼ãƒ³ã§ã€é›£ã—ã„ç”¨èªã¯å™›ã¿ç •ã„ã¦èª¬æ˜ã—ã¦ãã ã•ã„ã€‚'
    : `${tone}ã®ãƒˆãƒ¼ãƒ³ã§è¨˜äº‹ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚`;

  const systemPrompt = `ã‚ãªãŸã¯æµ·å¤–AIæƒ…å ±ã‚’æ—¥æœ¬èªã§ã‚ã‹ã‚Šã‚„ã™ãè§£èª¬ã™ã‚‹æŠ€è¡“ãƒ©ã‚¤ã‚¿ãƒ¼ã§ã™ã€‚
${toneInstruction}

ä»¥ä¸‹ã®å³å¯†ãªMarkdownæ§‹é€ ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼ˆã“ã®å½¢å¼ã‹ã‚‰å¤–ã‚Œãªã„ã“ã¨ï¼‰:

# ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆæ—¥æœ¬èªè¨³ï¼‰

> **3è¡Œã‚µãƒãƒªãƒ¼**
> - ï¼ˆ1è¡Œç›®ï¼‰
> - ï¼ˆ2è¡Œç›®ï¼‰
> - ï¼ˆ3è¡Œç›®ï¼‰

## æ¦‚è¦
ï¼ˆ2-3æ®µè½ã§æ¦‚è¦ã‚’èª¬æ˜ï¼‰

## ãƒã‚¤ãƒ³ãƒˆ
- ï¼ˆç®‡æ¡æ›¸ãã§é‡è¦ãƒã‚¤ãƒ³ãƒˆã‚’3-5ä»¶ï¼‰

## è§£èª¬
ï¼ˆè©³ç´°ãªè§£èª¬ã‚’3-5æ®µè½ï¼‰

---

## ã‚½ãƒ¼ã‚¹
- ğŸ“„ ä¸€æ¬¡æƒ…å ±: [ã‚¿ã‚¤ãƒˆãƒ«](URL)ï¼ˆç¨®åˆ¥ï¼‰
- ğŸ“° å‚ç…§è¨˜äº‹: [ã‚¿ã‚¤ãƒˆãƒ«](URL)

Generated by Mimi | ${today}`;

  const userPrompt = `ä»¥ä¸‹ã®è¨˜äº‹ã‚’æ—¥æœ¬èªè§£èª¬è¨˜äº‹ã«å¤‰æ›ã—ã¦ãã ã•ã„ã€‚

ã‚¿ã‚¤ãƒˆãƒ«: ${article.title}
URL: ${article.url}
${primarySourceInfo}
${contentSection}`;

  return client.chat(systemPrompt, userPrompt);
}
